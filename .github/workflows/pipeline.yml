name: RiskMetric Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate Bronze data
        run: python generator.py

      - name: Run dbt models (Silver + Gold)
        working-directory: riskmetric
        run: |
          RAW_PATH="${{ github.workspace }}/data/raw_transactions.parquet"
          USER_PATH="${{ github.workspace }}/data/user_profiles.parquet"
          dbt run --profiles-dir . --project-dir . --vars "{\"raw_transactions_path\": \"${RAW_PATH}\", \"user_profiles_path\": \"${USER_PATH}\"}"

      - name: Run dbt tests
        working-directory: riskmetric
        run: |
          RAW_PATH="${{ github.workspace }}/data/raw_transactions.parquet"
          USER_PATH="${{ github.workspace }}/data/user_profiles.parquet"
          dbt test --profiles-dir . --project-dir . --vars "{\"raw_transactions_path\": \"${RAW_PATH}\", \"user_profiles_path\": \"${USER_PATH}\"}"

      - name: Pipeline Summary
        run: |
          python -c "
          import duckdb
          conn = duckdb.connect('data/riskmetric.duckdb', read_only=True)
          total = conn.execute('SELECT COUNT(*) FROM gold_risk_scores').fetchone()[0]
          flagged = conn.execute('SELECT COUNT(*) FROM gold_risk_scores WHERE detected_fraud = TRUE').fetchone()[0]
          print(f'Total transactions: {total:,}')
          print(f'Flagged fraud: {flagged:,}')
          print(f'Fraud rate: {flagged/total*100:.2f}%')
          conn.close()
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: riskmetric-data
          path: |
            data/*.parquet
            data/riskmetric.duckdb
          retention-days: 7
